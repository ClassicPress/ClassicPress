# Guide to Maintaining ClassicPress

_This guide only applies to **core committers** - people who have access to
merge changes to ClassicPress._

## Merging PRs

ClassicPress uses the "Squash & Merge" option to merge PRs (pull requests) on
GitHub - this ensures that there is one commit for each PR in our official
commit history, which helps to keep the history clean.

Keeping a clean commit history is important because we use this information to
generate changelogs, and the commit history is one way for anyone to analyze
and monitor the history of the project in detail.  Keeping a clean commit
history also shows attention to detail as befits a professional-quality
software project.

This means that maintainers (core committers) may need to clean up the commit
messages as PRs are merged.

The full commit history for an individual PR should remain available on GitHub,
in the rare event that it is necessary to go back and see the individual
commits that made up a PR later on.

## Commit messages

Commit messages should mostly follow standard practice for Git commits [TODO:
link to a guide].  There are many different recommendations available online,
here are ours.

Git commit messages are separated into a **subject line** and a **body** with a
blank line in between them, as follows:

```
Subject line
```

```
Body paragraph 1

Body paragraph 2

Body paragraph n
```

GitHub presents the subject line and the body for editing in two separate
fields, so you don't have to worry about inserting the blank line.

### Subject line

The first line or **subject line** should be at most 72 characters long.
(There is a
[user script](https://gist.github.com/nylen/ab3937ff7fa9725db3be787b4425202f)
available for use with [Tampermonkey](https://www.tampermonkey.net/) or similar
that helps you stay under this limit when editing merge messages on GitHub.

The first line may include one or more optional _prefixes_:

- `WP-r12345: ` indicates a changeset that has been
  [backported](https://github.com/ClassicPress/ClassicPress/blob/develop/.github/CONTRIBUTING.md#backporting-changes-from-wordpress)
  from WordPress. If this prefix is present then it should come first.
- `Accessibility: ` indicates that the commit is related to accessibility.
  There is not a defined list of prefixes of this type, but they should
  generally be one or two words at most and should refer to a component or focus
  of the core software.

The rest of the first line should include a short but specific description of
the change being made in this PR. This description should start with an
infinitive (unconjugated) verb such as "Fix" or "Improve". This description
should not end with any punctuation.

Finally, the first line should end with a reference to the PR being merged in
the form ` (#123)` as GitHub does by default.

### Body

The commit body should include a more detailed explanation of the changes being
made in the PR.

By default, GitHub will accumulate the commit messages of all of the individual
commits in the PR into the commit body.  This is often a good starting point
but "noisy" commits of the form "Update somefile.php" should be removed from
this output.

Each paragraph in the commit body should be a full sentence that ends with a
period or other appropriate punctuation.

If one or more WordPress changesets have been backported in this PR, then the
commit body should include the _full, unmodified_ text of the WP commits as
generated by the backport script.  If subsequent commits were added to resolve
conflicts in the WP backports, then these lines should also be included.

It is recommended, but not required, to wrap lines in the commit body to 72
characters. (WordPress commit messages do not wrap long lines, so these long
lines should be left unmodified.)

If there are ClassicPress issues that are related to the PR, then they should
be referenced in the standard GitHub format (`#123`) in the commit body. It is
often useful to include these references on a line like `Fixes #123.` or
`Closes #123.` which will cause GitHub to automatically close that issue when
the PR is merged.

GitHub may include `Co-authored-by` lines at the end of the commit body. This
is the standard way of indicating multiple authors for a commit, and these
lines should be left alone.

### Examples

These examples are shown with the first line (subject line) by itself inside of
a code block. If there is a commit message body then this is shown inside a
separate code block, to structure the messages similarly to how they appear in
the GitHub interface's text entry fields.

##### Needs improvement:

**Commit Title**
```
Update user-edit.php (#123)
```

##### Better:
**Commit Title**
```
Improve stability of user dropdowns (#123)
```
**Commit Body**
```
When the author of one or more posts is an invalid (non-existent) user ID, this
leads to a PHP warning when showing a user dropdown. This PR fixes the warning
and causes an appropriate message to be shown in the user dropdown to allow the
user to leave the post as-is until the issue with the invalid author can be
solved properly.
```

---

GitHub will wrap long lines by default. We address this by summarizing the
change backported from WP in the subject line as concisely but specifically as
possible, and then repeating the entire, unmodified commit message for the
backported changeset in the commit body:

##### Needs improvement:
**Commit title**
```
WP-r47777: Administration: Avoid a PHP 7.4 notice in `add_meta_box()` ... (#778)
```
**Commit body**
```
... when attempting to re-add a previously removed box.

The logic for skipping previously removed meta boxes with the `core` priority should also apply to the `sorted` priority that is used when the boxes were manually reordered.

Add a unit test.

WP:Props coolmann, franzarmas, SergeyBiryukov.
Fixes https://core.trac.wordpress.org/ticket/50019.

Conflicts:
- src/wp-admin/includes/template.php
- tests/phpunit/tests/admin/includesTemplate.php

---

Merges https://core.trac.wordpress.org/changeset/47777 / WordPress/wordpress-develop@efb6e80 to ClassicPress.

* Fix conflicts from back-porting 47777

* Apply suggestions from code review

Co-authored-by: Sergey Biryukov <sergeybiryukov@git.wordpress.org>
Co-authored-by: James Nylen <jnylen@gmail.com>
```

##### Better:
**Commit title**
```
WP-r47777: Avoid notices when readding removed meta box in PHP 7.4 (#778)
```
**Commit body**
```
* WP-r47777: Administration: Avoid a PHP 7.4 notice in `add_meta_box()` when attempting to re-add a previously removed box.

The logic for skipping previously removed meta boxes with the `core` priority should also apply to the `sorted` priority that is used when the boxes were manually reordered.

Add a unit test.

WP:Props coolmann, franzarmas, SergeyBiryukov.
Fixes https://core.trac.wordpress.org/ticket/50019.

Conflicts:
- src/wp-admin/includes/template.php
- tests/phpunit/tests/admin/includesTemplate.php

---

Merges https://core.trac.wordpress.org/changeset/47777 / WordPress/wordpress-develop@efb6e80 to ClassicPress.

* Fix conflicts from back-porting 47777

* Apply suggestions from code review

Co-authored-by: Sergey Biryukov <sergeybiryukov@git.wordpress.org>
Co-authored-by: James Nylen <jnylen@gmail.com>
```

---

Another example of a commit message that is perhaps a bit overdone, but shows
how to use all of the fields available in the commit message:
https://github.com/ClassicPress/ClassicPress/commit/c995b8fd13a329ed6bb969226ef0a16dea3024a2

Things to note:

- The title (subject line) is a short summary of the change.
- The change is explained in more detail at the beginning of the message body.
- The full, unmodified commit messages for all backported WP changesets are
  included in the message body.
- The commit title is "_WP-r49944: Quick/Bulk Edit: Keep top and bottom forms
  consistent (#588)_". Normally when multiple WP changesets are backported in a
  single PR, the WP changeset number/prefix is not included and the title might
  be something like "_Backport WP fixes for ..._" instead. However, since this
  PR includes WP changesets that effectively cancel each other out (the initial
  fix for this issue plus its revert), changeset 49944 is the main fix included
  in this PR so it was included in the commit message title.
