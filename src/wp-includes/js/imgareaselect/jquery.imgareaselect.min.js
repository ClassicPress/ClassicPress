!function(e){var t=Math.abs,o=Math.max,i=Math.min,n=Math.round;function s(){return e("<div/>")}e.imgAreaSelect=function(r,d){var c,a,u,l,h,f,m,p,y,g,v,b,x,w,S,z,k,C,A,W,I,K,P,N,H,M,E,O,T,L=e(r),j=s(),D=s(),R=s().add(s()).add(s()).add(s()),X=s().add(s()).add(s()).add(s()),Y=e([]),$={left:0,top:0},q={left:0,top:0},B=0,Q="absolute",F={x1:0,y1:0,x2:0,y2:0,width:0,height:0},G=document.documentElement,J=navigator.userAgent;function U(e){return e+$.left-q.left}function V(e){return e+$.top-q.top}function Z(e){return e-$.left+q.left}function _(e){return e-$.top+q.top}function ee(e){return o(e.pageX||0,oe(e).x)-q.left}function te(e){return o(e.pageY||0,oe(e).y)-q.top}function oe(e){var t=e.originalEvent||{};return t.touches&&t.touches.length?{x:t.touches[0].pageX,y:t.touches[0].pageY}:{x:0,y:0}}function ie(e){var t=e||g,o=e||v;return{x1:n(F.x1*t),y1:n(F.y1*o),x2:n(F.x2*t),y2:n(F.y2*o),width:n(F.x2*t)-n(F.x1*t),height:n(F.y2*o)-n(F.y1*o)}}function ne(e,t,o,i,s){var r=s||g,d=s||v;(F={x1:n(e/r||0),y1:n(t/d||0),x2:n(o/r||0),y2:n(i/d||0)}).width=F.x2-F.x1,F.height=F.y2-F.y1}function se(){c&&L.width()&&($={left:n(L.offset().left),top:n(L.offset().top)},h=L.innerWidth(),f=L.innerHeight(),$.top+=L.outerHeight()-f>>1,$.left+=L.outerWidth()-h>>1,x=n(d.minWidth/g)||0,w=n(d.minHeight/v)||0,S=n(i(d.maxWidth/g||1<<24,h)),z=n(i(d.maxHeight/v||1<<24,f)),"1.3.2"!=e().jquery||"fixed"!=Q||G.getBoundingClientRect||($.top+=o(document.body.scrollTop,G.scrollTop),$.left+=o(document.body.scrollLeft,G.scrollLeft)),q=/absolute|relative/.test(m.css("position"))?{left:n(m.offset().left)-m.scrollLeft(),top:n(m.offset().top)-m.scrollTop()}:"fixed"==Q?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0},u=U(0),l=V(0),(F.x2>h||F.y2>f)&&fe())}function re(t){if(C){switch(j.css({left:U(F.x1),top:V(F.y1)}).add(D).width(E=F.width).height(O=F.height),D.add(R).add(Y).css({left:0,top:0}),R.width(o(E-R.outerWidth()+R.innerWidth(),0)).height(o(O-R.outerHeight()+R.innerHeight(),0)),e(X[0]).css({left:u,top:l,width:F.x1,height:f}),e(X[1]).css({left:u+F.x1,top:l,width:E,height:F.y1}),e(X[2]).css({left:u+F.x2,top:l,width:h-F.x2,height:f}),e(X[3]).css({left:u+F.x1,top:l+F.y2,width:E,height:f-F.y2}),E-=Y.outerWidth(),O-=Y.outerHeight(),Y.length){case 8:e(Y[4]).css({left:E>>1}),e(Y[5]).css({left:E,top:O>>1}),e(Y[6]).css({left:E>>1,top:O}),e(Y[7]).css({top:O>>1});case 4:Y.slice(1,3).css({left:E}),Y.slice(2,4).css({top:O})}!1!==t&&(e.imgAreaSelect.onKeyPress!=Se&&e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress),d.keys&&e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=Se)),Ce&&R.outerWidth()-R.innerWidth()==2&&(R.css("margin",0),setTimeout((function(){R.css("margin","auto")}),0))}}function de(e){se(),re(e),A=U(F.x1),W=V(F.y1),I=U(F.x2),K=V(F.y2)}function ce(e,t){d.fadeSpeed?e.fadeOut(d.fadeSpeed,t):e.hide()}function ae(e){var t=Z(ee(e))-F.x1,o=_(te(e))-F.y1;T||(se(),T=!0,j.one("mouseout",(function(){T=!1}))),b="",d.resizable&&(o<=d.resizeMargin?b="n":o>=F.height-d.resizeMargin&&(b="s"),t<=d.resizeMargin?b+="w":t>=F.width-d.resizeMargin&&(b+="e")),j.css("cursor",b?b+"-resize":d.movable?"move":""),a&&a.toggle()}function ue(t){e("body").css("cursor",""),(d.autoHide||F.width*F.height==0)&&ce(j.add(X),(function(){e(this).hide()})),e(document).off("mousemove touchmove",me),j.on("mousemove touchmove",ae),d.onSelectEnd(r,ie())}function le(t){return"mousedown"==t.type&&1!=t.which||(ae(t),se(),b?(e("body").css("cursor",b+"-resize"),A=U(F[/w/.test(b)?"x2":"x1"]),W=V(F[/n/.test(b)?"y2":"y1"]),e(document).on("mousemove touchmove",me).one("mouseup touchend",ue),j.off("mousemove touchmove",ae)):d.movable?(p=u+F.x1-ee(t),y=l+F.y1-te(t),j.off("mousemove touchmove",ae),e(document).on("mousemove touchmove",ye).one("mouseup touchend",(function(){d.onSelectEnd(r,ie()),e(document).off("mousemove touchmove",ye),j.on("mousemove touchmove",ae)}))):L.mousedown(t)),!1}function he(e){k&&(e?(I=o(u,i(u+h,A+t(K-W)*k*(I>A||-1))),K=n(o(l,i(l+f,W+t(I-A)/k*(K>W||-1)))),I=n(I)):(K=o(l,i(l+f,W+t(I-A)/k*(K>W||-1))),I=n(o(u,i(u+h,A+t(K-W)*k*(I>A||-1)))),K=n(K)))}function fe(){A=i(A,u+h),W=i(W,l+f),t(I-A)<x&&((I=A-x*(I<A||-1))<u?A=u+x:I>u+h&&(A=u+h-x)),t(K-W)<w&&((K=W-w*(K<W||-1))<l?W=l+w:K>l+f&&(W=l+f-w)),I=o(u,i(I,u+h)),K=o(l,i(K,l+f)),he(t(I-A)<t(K-W)*k),t(I-A)>S&&(I=A-S*(I<A||-1),he()),t(K-W)>z&&(K=W-z*(K<W||-1),he(!0)),F={x1:Z(i(A,I)),x2:Z(o(A,I)),y1:_(i(W,K)),y2:_(o(W,K)),width:t(I-A),height:t(K-W)},re(),d.onSelectChange(r,ie())}function me(e){return I=/w|e|^$/.test(b)||k?ee(e):U(F.x2),K=/n|s|^$/.test(b)||k?te(e):V(F.y2),fe(),!1}function pe(t,o){I=(A=t)+F.width,K=(W=o)+F.height,e.extend(F,{x1:Z(A),y1:_(W),x2:Z(I),y2:_(K)}),re(),d.onSelectChange(r,ie())}function ye(e){return A=o(u,i(p+ee(e),u+h-F.width)),W=o(l,i(y+te(e),l+f-F.height)),pe(A,W),e.preventDefault(),!1}function ge(){e(document).off("mousemove touchmove",ge),se(),I=A,K=W,fe(),b="",X.is(":visible")||j.add(X).hide().fadeIn(d.fadeSpeed||0),C=!0,e(document).off("mouseup touchend",ve).on("mousemove touchmove",me).one("mouseup touchend",ue),j.off("mousemove touchmove",ae),d.onSelectStart(r,ie())}function ve(){e(document).off("mousemove touchmove",ge).off("mouseup touchend",ve),ce(j.add(X)),ne(Z(A),_(W),Z(A),_(W)),this instanceof e.imgAreaSelect||(d.onSelectChange(r,ie()),d.onSelectEnd(r,ie()))}function be(t){return t.which>1||X.is(":animated")||(se(),p=A=ee(t),y=W=te(t),e(document).on({"mousemove touchmove":ge,"mouseup touchend":ve})),!1}function xe(){de(!1)}function we(){c=!0,ke(d=e.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d)),j.add(X).css({visibility:""}),d.show&&(C=!0,se(),re(),j.add(X).hide().fadeIn(d.fadeSpeed||0)),setTimeout((function(){d.onInit(r,ie())}),0)}var Se=function(e){var t,n,s=d.keys,r=e.keyCode;if(t=isNaN(s.alt)||!e.altKey&&!e.originalEvent.altKey?!isNaN(s.ctrl)&&e.ctrlKey?s.ctrl:!isNaN(s.shift)&&e.shiftKey?s.shift:isNaN(s.arrows)?10:s.arrows:s.alt,"resize"==s.arrows||"resize"==s.shift&&e.shiftKey||"resize"==s.ctrl&&e.ctrlKey||"resize"==s.alt&&(e.altKey||e.originalEvent.altKey)){switch(r){case 37:t=-t;case 39:n=o(A,I),A=i(A,I),I=o(n+t,A),he();break;case 38:t=-t;case 40:n=o(W,K),W=i(W,K),K=o(n+t,W),he(!0);break;default:return}fe()}else switch(A=i(A,I),W=i(W,K),r){case 37:pe(o(A-t,u),W);break;case 38:pe(A,o(W-t,l));break;case 39:pe(A+i(t,h-Z(I)),W);break;case 40:pe(A,W+i(t,f-_(K)));break;default:return}return!1};function ze(e,t){for(var o in t)d[o]!==undefined&&e.css(t[o],d[o])}function ke(t){if(t.parent&&(m=e(t.parent)).append(j.add(X)),e.extend(d,t),se(),null!=t.handles){for(Y.remove(),Y=e([]),H=t.handles?"corners"==t.handles?4:8:0;H--;)Y=Y.add(s());Y.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:B+1||1}),!parseInt(Y.css("width"))>=0&&Y.width(5).height(5),(M=d.borderWidth)&&Y.css({borderWidth:M,borderStyle:"solid"}),ze(Y,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}for(g=d.imageWidth/h||1,v=d.imageHeight/f||1,null!=t.x1&&(ne(t.x1,t.y1,t.x2,t.y2),t.show=!t.hide),t.keys&&(d.keys=e.extend({shift:1,ctrl:"resize"},t.keys)),X.addClass(d.classPrefix+"-outer"),D.addClass(d.classPrefix+"-selection"),H=0;H++<4;)e(R[H-1]).addClass(d.classPrefix+"-border"+H);ze(D,{selectionColor:"background-color",selectionOpacity:"opacity"}),ze(R,{borderOpacity:"opacity",borderWidth:"border-width"}),ze(X,{outerColor:"background-color",outerOpacity:"opacity"}),(M=d.borderColor1)&&e(R[0]).css({borderStyle:"solid",borderColor:M}),(M=d.borderColor2)&&e(R[1]).css({borderStyle:"dashed",borderColor:M}),j.append(D.add(R).add(a)).append(Y),Ce&&((M=(X.css("filter")||"").match(/opacity=(\d+)/))&&X.css("opacity",M[1]/100),(M=(R.css("filter")||"").match(/opacity=(\d+)/))&&R.css("opacity",M[1]/100)),t.hide?ce(j.add(X)):t.show&&c&&(C=!0,j.add(X).fadeIn(d.fadeSpeed||0),de()),k=(N=(d.aspectRatio||"").split(/:/))[0]/N[1],L.add(X).unbind("mousedown",be),d.disable||!1===d.enable?(j.off({"mousemove touchmove":ae,"mousedown touchstart":le}),e(window).off("resize",xe)):((d.enable||!1===d.disable)&&((d.resizable||d.movable)&&j.on({"mousemove touchmove":ae,"mousedown touchstart":le}),e(window).resize(xe)),d.persistent||L.add(X).on("mousedown touchstart",be)),d.enable=d.disable=undefined}this.remove=function(){ke({disable:!0}),j.add(X).remove()},this.getOptions=function(){return d},this.setOptions=ke,this.getSelection=ie,this.setSelection=ne,this.cancelSelection=ve,this.update=de;var Ce=(/msie ([\w.]+)/i.exec(J)||[])[1],Ae=/opera/i.test(J),We=/webkit/i.test(J)&&!/chrome/i.test(J);for(P=L;P.length;)B=o(B,isNaN(P.css("z-index"))?B:P.css("z-index")),"fixed"==P.css("position")&&(Q="fixed"),P=P.parent(":not(body)");B=d.zIndex||B,Ce&&L.attr("unselectable","on"),e.imgAreaSelect.keyPress=Ce||We?"keydown":"keypress",Ae&&(a=s().css({width:"100%",height:"100%",position:"absolute",zIndex:B+2||2})),j.add(X).css({visibility:"hidden",position:Q,overflow:"hidden",zIndex:B||"0"}),j.css({zIndex:B+2||2}),D.add(R).css({position:"absolute",fontSize:0}),r.complete||"complete"==r.readyState||!L.is("img")?we():L.one("load",we),!c&&Ce&&Ce>=7&&(r.src=r.src)},e.fn.imgAreaSelect=function(t){return t=t||{},this.each((function(){e(this).data("imgAreaSelect")?t.remove?(e(this).data("imgAreaSelect").remove(),e(this).removeData("imgAreaSelect")):e(this).data("imgAreaSelect").setOptions(t):t.remove||(t.enable===undefined&&t.disable===undefined&&(t.enable=!0),e(this).data("imgAreaSelect",new e.imgAreaSelect(this,t)))})),t.instance?e(this).data("imgAreaSelect"):this}}(jQuery);